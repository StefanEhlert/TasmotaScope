# CouchDB separat für TasmotaScope (wie ursprüngliche einfache Variante)
# Start: docker compose -f docker-compose.couchdb.yml up -d
# Dann im Frontend unter Einstellungen CouchDB verbinden (Host = Server-IP, Port 5984, User/Pass/Datenbank wie unten)

services:
  couchdb:
    image: couchdb:3
    container_name: tasmotascope-couchdb
    restart: unless-stopped
    ports:
      - "${COUCHDB_PORT:-5984}:5984"
    environment:
      COUCHDB_USER: ${COUCHDB_USER:-admin}
      COUCHDB_PASSWORD: ${COUCHDB_PASSWORD:-change-me}
    volumes:
      - couchdb_data:/opt/couchdb/data
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:5984/_up || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - tasmotascope-couchdb

  couchdb-init:
    image: curlimages/curl:latest
    container_name: tasmotascope-couchdb-init
    depends_on:
      couchdb:
        condition: service_healthy
    environment:
      COUCHDB_USER: ${COUCHDB_USER:-admin}
      COUCHDB_PASSWORD: ${COUCHDB_PASSWORD:-change-me}
      COUCHDB_DATABASE: ${COUCHDB_DATABASE:-tasmotascope}
    command:
      - sh
      - -c
      - |
        echo 'CouchDB-Init: CORS und Datenbank anlegen...'
        sleep 3
        curl -sS -X PUT "http://$$COUCHDB_USER:$$COUCHDB_PASSWORD@couchdb:5984/_node/_local/_config/httpd/enable_cors" -d '"true"'
        curl -sS -X PUT "http://$$COUCHDB_USER:$$COUCHDB_PASSWORD@couchdb:5984/_node/_local/_config/cors/origins" -d '"*"'
        curl -sS -X PUT "http://$$COUCHDB_USER:$$COUCHDB_PASSWORD@couchdb:5984/_node/_local/_config/cors/credentials" -d '"true"'
        curl -sS -X PUT "http://$$COUCHDB_USER:$$COUCHDB_PASSWORD@couchdb:5984/_node/_local/_config/cors/methods" -d '"GET, PUT, POST, HEAD, DELETE, OPTIONS"'
        curl -sS -X PUT "http://$$COUCHDB_USER:$$COUCHDB_PASSWORD@couchdb:5984/_node/_local/_config/cors/headers" -d '"accept, authorization, content-type, origin, referer, x-csrf-token"'
        curl -sS -X PUT "http://$$COUCHDB_USER:$$COUCHDB_PASSWORD@couchdb:5984/_users" || true
        curl -sS -X PUT "http://$$COUCHDB_USER:$$COUCHDB_PASSWORD@couchdb:5984/_replicator" || true
        curl -sS -X PUT "http://$$COUCHDB_USER:$$COUCHDB_PASSWORD@couchdb:5984/_global_changes" || true
        curl -sS -X PUT "http://$$COUCHDB_USER:$$COUCHDB_PASSWORD@couchdb:5984/$$COUCHDB_DATABASE" || true
        echo 'CouchDB-Init fertig.'
    networks:
      - tasmotascope-couchdb
    restart: "no"

volumes:
  couchdb_data:
    driver: local

networks:
  tasmotascope-couchdb:
    driver: bridge
